<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>刷题系统 + DeepSeek 解析</title>
  <style>
    body { font-family:Arial,Helvetica,sans-serif; max-width:800px; margin:0 auto; padding:20px }
    .option { margin:6px 0; cursor:pointer; display:block; padding:6px 12px; border:1px solid #ccc; border-radius:5px }
    .option:hover { background:#f0f0f0 }
    .correct { background:#d0f5d0 }
    .wrong { background:#f5d0d0 }
    #controls button { margin-right:10px }
    #explainBox { margin-top:16px; white-space:pre-wrap; background:#f7f7f7; padding:12px; border-radius:6px; border-left:5px solid #00897b }
  </style>
</head>
<body>

<h2 id="questionTitle">加载中...</h2>
<div id="optionsBox"></div>

<div id="controls">
  <button onclick="prevQuestion()">上一题</button>
  <button onclick="nextQuestion()">下一题</button>
  <button onclick="toggleFavorite()">⭐ 收藏</button>
  <button onclick="showNav()">题号导航</button>
  <button onclick="generateExplanation()">🧠 生成解析</button>
</div>

<div id="explainBox"></div>

<div id="navBox" style="display:none; margin-top:10px;"></div>
<div style="height:500px"></div>

<script>
let questions = [
  { q: "地球是圆的，对吗？", options: ["对", "错"], answer: 0 },
  { q: "2+2 等于几？", options: ["1","2","3","4"], answer: 3 },
];
let current = 0;
let favorites = JSON.parse(localStorage.getItem('favorites')||'[]');
let answers = JSON.parse(localStorage.getItem('answers')||'{}');

function render(){
  const box = document.getElementById("optionsBox");
  const q = questions[current];
  document.getElementById("questionTitle").textContent = `第 ${current+1} 题：${q.q}`;
  box.innerHTML = '';
  q.options.forEach((opt, i)=>{
    const btn = document.createElement("div");
    btn.className = 'option';
    btn.textContent = `${i+1}. ${opt}`;
    if (answers[current] !== undefined) {
      if (i === q.answer) btn.classList.add('correct');
      if (i === answers[current] && i !== q.answer) btn.classList.add('wrong');
    }
    btn.onclick = ()=>selectOption(i);
    box.appendChild(btn);
  });
  updateNavBox();
}
function selectOption(i){
  answers[current] = i;
  localStorage.setItem('answers', JSON.stringify(answers));
  render();
}
function prevQuestion(){ if(current>0) current--; render(); }
function nextQuestion(){ if(current<questions.length-1) current++; render(); }
function toggleFavorite(){
  if (!favorites.includes(current)) favorites.push(current);
  else favorites = favorites.filter(i => i !== current);
  localStorage.setItem('favorites', JSON.stringify(favorites));
  render();
}
function showNav(){
  const nav = document.getElementById("navBox");
  nav.style.display = nav.style.display==='none'?'block':'none';
}
function updateNavBox(){
  const nav = document.getElementById("navBox");
  nav.innerHTML = '';
  questions.forEach((_,i)=>{
    const btn = document.createElement("button");
    btn.textContent = i+1;
    btn.style.marginRight = '6px';
    if(answers[i] !== undefined) btn.style.background = '#cce7ff';
    if(favorites.includes(i)) btn.textContent = '⭐'+(i+1);
    btn.onclick = ()=>{current=i;render();};
    nav.appendChild(btn);
  });
}
document.addEventListener('keydown', e=>{
  if(e.key==='Enter') nextQuestion();
  if(/[1-9]/.test(e.key)){
    const idx = parseInt(e.key)-1;
    if(questions[current].options[idx]) selectOption(idx);
  }
});

async function generateExplanation(){
  const q = questions[current];
  const box = document.getElementById("explainBox");
  box.textContent = '⏳ DeepSeek 思考中...';
  try {
    const res = await fetch('/api/explain', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ prompt: q.q })
    });
    const data = await res.json();
    box.textContent = data.explanation || '解释失败';
  } catch {
    box.textContent = '网络错误';
  }
}

render();
</script>

</body>
</html>
