<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Quick Quiz Builder V8 + DeepSeek</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;max-width:900px;margin:0 auto;padding:24px;background:#f7f7f7}
h1{margin-bottom:12px}
#explainBox{
  white-space: pre-wrap;   /* ä¿ç•™æ¢è¡Œï¼ŒåŒæ—¶å…è®¸è‡ªåŠ¨æŠ˜è¡Œ */
  word-break: break-all;   /* éœ€è¦æ—¶åœ¨ä»»æ„å­—æ¯æ–­è¡Œï¼Œé¿å…é•¿è‹±æ–‡æ’‘å‡ºå®¹å™¨ */
  overflow-wrap: anywhere; /* ä¿é™©ï¼šé•¿å•è¯ä¹Ÿèƒ½æ–­ */
  margin-top: 6px;
}

textarea{width:100%;height:240px;font-family:Consolas,monospace;font-size:14px;padding:8px;border:1px solid #ccc;border-radius:4px}
button{padding:6px 14px;font-size:15px;margin:5px 4px;border:none;border-radius:4px;cursor:pointer;background:#1976d2;color:#fff}
button[disabled]{background:#999;cursor:not-allowed}
#quiz-container{background:#fff;padding:20px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.15);margin-top:20px;display:none;position:relative}
.option{margin:6px 0;display:block}
.feedback{margin-top:10px;font-weight:bold}
.correct{color:#2e7d32}
.incorrect{color:#c62828}
#top-btns{position:absolute;top:10px;right:10px;display:flex;gap:6px;z-index:10}
.top-icon{font-size:18px;background:none;border:none;color:#d32f2f;padding:0 4px;cursor:pointer}
.top-icon.jump{color:#00897b}
.top-icon.faved{color:#fdd835}
.modal{display:none;position:fixed;top:10%;left:50%;transform:translateX(-50%);width:85%;max-width:650px;background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);max-height:80%;overflow:auto;padding:18px}
.modal h2{margin-top:0}
.jump-grid{display:flex;flex-wrap:wrap;gap:6px}
.jump-grid button{width:42px;border-radius:4px;padding:6px 0;background:#607d8b}
.jump-grid button.done{background:#90caf9;color:#000}
.jump-grid button.current{border:2px solid #ffeb3b}
#explainBtn{background:#00897b}
</style>
</head>
<body>
<h1>Quick Quiz Builder V8 + DeepSeek</h1>
<p>ç²˜è´´é¢˜åº“ï¼Œæ•°å­— <strong>1â€“8</strong> å¿«é€Ÿé€‰é¡¹ï¼Œ<strong>Enter</strong> æäº¤/ä¸‹ä¸€é¢˜ã€‚</p>

<textarea id="raw-input" placeholder="æŠŠé¢˜åº“ç²˜è´´åˆ°è¿™é‡Œâ€¦"></textarea><br>
<button id="build-btn">ç”Ÿæˆåˆ·é¢˜</button>
<button id="save-btn" style="background:#455a64">ä¿å­˜é¢˜åº“</button>
<button id="show-bank-btn" style="background:#37474f">é¢˜åº“</button>
<button id="fav-quiz-btn" style="display:none;background:#388e3c">åˆ·æ”¶è—é¢˜</button>
<button id="manage-fav-btn" style="display:none;background:#8e24aa">ç®¡ç†æ”¶è—å¤¹</button>

<div id="quiz-container">
  <div id="top-btns">
    <button id="jump-btn" class="top-icon jump" title="é¢˜å·å¯¼èˆª">ğŸ“‘</button>
    <button id="fav-btn" class="top-icon" title="æ”¶è—/å–æ¶ˆæ”¶è—">â˜…</button>
  </div>
  <div id="q-num"></div>
  <p id="question-text" class="question-text"></p>
  <div id="options-area"></div>
  <button id="prev-btn" style="display:none;background:#5e35b1">ä¸Šä¸€é¢˜</button>
  <button id="action-btn" disabled>æäº¤</button>
  <button id="explainBtn" style="display:none;">ç”Ÿæˆè§£æ</button>
  <pre id="explainBox"></pre>
  <p id="feedback" class="feedback"></p>
</div>

<div id="fav-manager" class="modal">
  <h2>æ”¶è—å¤¹</h2>
  <div id="fav-list"></div>
  <button onclick="closeModal('fav-manager')">å…³é—­</button>
</div>

<div id="jump-modal" class="modal">
  <h2>è·³è½¬åˆ°é¢˜å·</h2>
  <div id="jump-grid" class="jump-grid"></div>
  <button onclick="closeModal('jump-modal')">å…³é—­</button>
</div>

<div id="bank-modal" class="modal">
  <h2>å·²ä¿å­˜é¢˜åº“</h2>
  <div id="bank-list"></div>
  <button onclick="closeModal('bank-modal')">å…³é—­</button>
</div>

<div style="height:800px;"></div>

<script>
const $=id=>document.getElementById(id);

// elements
const rawInput=$('raw-input'), buildBtn=$('build-btn'), saveBtn=$('save-btn'), showBankBtn=$('show-bank-btn');
const favQuizBtn=$('fav-quiz-btn'), manageFavBtn=$('manage-fav-btn');
const quizBox=$('quiz-container'), qNum=$('q-num'), qText=$('question-text'), optsArea=$('options-area');
const actionBtn=$('action-btn'), prevBtn=$('prev-btn'), feedback=$('feedback'), favBtn=$('fav-btn'), jumpBtn=$('jump-btn');
const favManager=$('fav-manager'), favList=$('fav-list');
const jumpModal=$('jump-modal'), jumpGrid=$('jump-grid');
const bankModal=$('bank-modal'), bankList=$('bank-list');
const explainBtn = document.getElementById('explainBtn');
const explainBox = document.getElementById('explainBox');

// data
let quiz=[],current=0,userChoices=[],gradedStatus=[];
let favorites=JSON.parse(localStorage.getItem('favorites')||'[]');
let quizBank=JSON.parse(localStorage.getItem('quizBank')||'[]');

const saveStorage=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
function updateFavButtons(){const vis=favorites.length?'inline-block':'none';favQuizBtn.style.display=vis;manageFavBtn.style.display=vis;}updateFavButtons();

function parseText(txt){
  const lines=txt.replace(/\r/g,'').split('\n');const out=[];let i=0;
  while(i<lines.length){if(!lines[i].trim()){i++;continue;}
    const qLine=lines[i++].trim();
    let opts=[];while(i<lines.length&&!lines[i].startsWith('*')){if(lines[i].trim())opts.push(lines[i].trim());i++;}
    const ans=i<lines.length?lines[i].trim():'';
    i++;const joined=opts.join(' ');
    const parts=joined.split(/\s*(?=[A-Hï¼¡-ï¼¨][\.ï¼ã€])/).filter(Boolean);
    const options=parts.map(p=>{const m=p.match(/^([A-Hï¼¡-ï¼¨])[\.ï¼ã€]?\s*(.+)$/);return m?[m[1].toUpperCase(),m[2].trim()]:null}).filter(Boolean);
    out.push({question:qLine.replace(/^\d+\./,''),options,answer:ans.replace(/^\*/,'').replace(/!$/,'').toUpperCase().split('')});
  }return out;
}

function isFav(q){return favorites.some(f=>f.question===q);}
function toggleFav(q){const idx=favorites.findIndex(f=>f.question===q.question);idx>-1?favorites.splice(idx,1):favorites.push(q);saveStorage('favorites',favorites);updateFavButtons();favBtn.classList.toggle('faved',idx===-1);}

function renderQuestion(){
  const q=quiz[current];qNum.textContent=`é¢˜ç›® ${current+1}/${quiz.length}`;qText.textContent=q.question;
  optsArea.innerHTML='';feedback.textContent='';explainBox.textContent='';explainBtn.style.display='none'; // Reset explanation
  const wasGraded=gradedStatus[current];actionBtn.textContent=wasGraded?'ä¸‹ä¸€é¢˜':'æäº¤';actionBtn.disabled=!userChoices[current]?.length;
  prevBtn.style.display=current>0?'inline-block':'none';favBtn.classList.toggle('faved',isFav(q.question));
  const multi=q.answer.length>1;
  q.options.forEach(([lab,txt])=>{const label=document.createElement('label');label.className='option';
      const ipt=document.createElement('input');ipt.type=multi?'checkbox':'radio';ipt.name='opt';ipt.value=lab;
      ipt.onchange=()=>{actionBtn.disabled=false;gradedStatus[current]=false;feedback.textContent='';actionBtn.textContent='æäº¤';explainBox.textContent='';explainBtn.style.display='none';}; // Clear explanation on option change
      label.appendChild(ipt);label.append(` ${lab}. ${txt}`);optsArea.appendChild(label);});
  if(userChoices[current]) [...optsArea.querySelectorAll('input')].forEach(i=>i.checked=userChoices[current].includes(i.value));
  if(wasGraded) showFeedback();
  favBtn.onclick=()=>toggleFav(q);
}

function showFeedback(){
  const corr=quiz[current].answer.sort().join('');
  const sel=(userChoices[current]||[]).sort().join('');
  const ok=sel===corr;
  feedback.textContent=ok?'âœ”ï¸ æ­£ç¡®':'âœ–ï¸ é”™è¯¯ï¼Œæ­£ç¡®ç­”æ¡ˆ: '+corr.split('').join(',');
  feedback.className='feedback '+(ok?'correct':'incorrect');
  explainBtn.style.display = 'inline-block'; // Show explain button after grading
}

function submit(){
  const sel=[...optsArea.querySelectorAll('input')].filter(i=>i.checked).map(i=>i.value).sort();
  if(!sel.length){alert('å…ˆé€‰ç­”æ¡ˆ');return;}
  userChoices[current]=sel;
  gradedStatus[current]=true;
  actionBtn.textContent=current<quiz.length-1?'ä¸‹ä¸€é¢˜':'å®Œæˆ';
  showFeedback();
  // Dispatch a custom event to notify that quiz has been graded
  document.dispatchEvent(new CustomEvent('quiz-graded'));
}

actionBtn.onclick=()=>{gradedStatus[current]? (current<quiz.length-1? (current++,renderQuestion()):endQuiz()) : submit();};
prevBtn.onclick=()=>{current--;renderQuestion();};
function endQuiz(){const score=quiz.reduce((s,_,i)=>s+((userChoices[i]||[]).sort().join('')===quiz[i].answer.sort().join('')?1:0),0);qNum.textContent='å®Œæˆï¼';qText.textContent=`å¾—åˆ† ${score}/${quiz.length}`;optsArea.innerHTML='';actionBtn.style.display='none';prevBtn.style.display='none';favBtn.style.display='none';jumpBtn.style.display='none';feedback.textContent='';explainBtn.style.display='none';explainBox.textContent='';} // Hide explain at end
function startQuiz(text,fromFav){quiz=fromFav?[...favorites]:parseText(text);if(!quiz.length){alert('é¢˜åº“ä¸ºç©ºæˆ–æ ¼å¼é”™');return;}current=0;userChoices=[];gradedStatus=[];quizBox.style.display='block';jumpBtn.style.display='inline-block';renderQuestion();}
buildBtn.onclick=()=>startQuiz(rawInput.value.trim(),false);favQuizBtn.onclick=()=>startQuiz('',true);

// keyboard shortcuts
document.addEventListener('keydown',e=>{
  if(document.activeElement===rawInput) return;
  if(e.key>='1'&&e.key<='8'){ // map 1->A, 2->B...
      const idx=parseInt(e.key,10)-1;
      const letter=String.fromCharCode('A'.charCodeAt(0)+idx);
      const ipt=optsArea.querySelector(`input[value="${letter}"]`);
      if(ipt){if(ipt.type==='checkbox') ipt.checked=!ipt.checked; else ipt.checked=true; ipt.dispatchEvent(new Event('change')); }
  }else if(e.key==='Enter'){e.preventDefault();actionBtn.click();}
});

// save bank / show bank
saveBtn.onclick=()=>{const t=rawInput.value.trim();if(!t){alert('ç©ºé¢˜åº“');return;}const n=prompt('é¢˜åº“åç§°');if(!n)return;quizBank.push({name:n,text:t});saveStorage('quizBank',quizBank);alert('å·²ä¿å­˜');};
showBankBtn.onclick=()=>{renderBank();bankModal.style.display='block';};
function renderBank(){bankList.innerHTML='';if(!quizBank.length){bankList.textContent='æš‚æ— é¢˜åº“';return;}quizBank.forEach((q,i)=>{const div=document.createElement('div');div.style.borderBottom='1px solid #ccc';div.style.padding='6px 0';div.append(`${q.name} `);const load=document.createElement('button');load.textContent='åŠ è½½';load.onclick=()=>{rawInput.value=q.text;closeModal('bank-modal');startQuiz(q.text,false);};const del=document.createElement('button');del.textContent='åˆ é™¤';del.style.background='#c62828';del.onclick=()=>{if(confirm('åˆ é™¤?')){quizBank.splice(i,1);saveStorage('quizBank',quizBank);renderBank();}};div.append(load,del);bankList.appendChild(div);});}
// fav manager
manageFavBtn.onclick=()=>{renderFav();favManager.style.display='block';};
function renderFav(){favList.innerHTML='';if(!favorites.length){favList.textContent='æš‚æ— æ”¶è—';return;}favorites.forEach((q,i)=>{const div=document.createElement('div');div.style.borderBottom='1px solid #ccc';div.style.padding='6px 0';div.append(`${i+1}. ${q.question} `);const del=document.createElement('button');del.textContent='åˆ é™¤';del.style.background='#c62828';del.onclick=()=>{favorites.splice(i,1);saveStorage('favorites',favorites);renderFav();};div.append(del);favList.appendChild(div);});}
// jump grid
jumpBtn.onclick=()=>{renderJump();jumpModal.style.display='block';};
function renderJump(){jumpGrid.innerHTML='';quiz.forEach((_,i)=>{const b=document.createElement('button');b.textContent=i+1;if(gradedStatus[i])b.classList.add('done');if(i===current)b.classList.add('current');b.onclick=()=>{current=i;renderQuestion();closeModal('jump-modal');};jumpGrid.appendChild(b);});}
function closeModal(id){$(id).style.display='none';}

// DeepSeek è°ƒç”¨
async function askDeepSeek(prompt){
    const res = await fetch('https://quiz-ivory-eight-13.vercel.app/api/explain', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({prompt})
  });
  const data = await res.json();
  // ç¡®ä¿è¿™é‡Œè¿”å›çš„æ˜¯æ‚¨çš„Vercel APIè·¯ç”±è¿”å›çš„â€œexplanationâ€å­—æ®µ
  return data.explanation || 'è§£æå¤±è´¥';
}

explainBtn.addEventListener('click', async () => {
  // **è¿™é‡Œæ˜¯ä¿®æ”¹è¿‡çš„åœ°æ–¹ï¼Œç›´æ¥ä½¿ç”¨å…¨å±€å£°æ˜çš„ qText å’Œ optsArea**
  const questionTextContent = qText.innerText; // è·å–é—®é¢˜æ–‡æœ¬
  const optionsText = Array.from(optsArea.querySelectorAll('label')).map(l=>l.innerText).join('\n'); // è·å–é€‰é¡¹æ–‡æœ¬

  const myAns = (window.userChoices && window.userChoices[window.current]) ? window.userChoices[window.current].join(',') : '';
  const prompt = `é¢˜ç›®ï¼š${questionTextContent}\né€‰é¡¹ï¼š\n${optionsText}\næˆ‘é€‰æ‹©çš„ç­”æ¡ˆï¼š${myAns}\nè¯·ç»™å‡ºæ­£ç¡®ç­”æ¡ˆå¹¶ç®€è¦è§£æï¼ˆ200å­—å†…ï¼‰ã€‚`;

  explainBox.textContent = 'â³ è§£æç”Ÿæˆä¸­...';
  try {
    const txt = await askDeepSeek(prompt);
    explainBox.textContent = txt;
  } catch (e) {
    explainBox.textContent = 'è§£æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    console.error("ç”Ÿæˆè§£ææ—¶å‡ºé”™:", e); // åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°ä¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯
  }
});
</script>
</body>
</html>
